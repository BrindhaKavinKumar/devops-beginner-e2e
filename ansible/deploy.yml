- name: Deploy Dockerized Nginx app
  hosts: web
  become: true

  tasks:
    - name: Update apt + install base deps
      apt:
        update_cache: yes
        cache_valid_time: 3600
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: Unhold packages if any are held
      shell: |
        set -e
        apt-mark showhold || true
        apt-mark unhold containerd docker.io docker-ce docker-ce-cli containerd.io || true

    - name: Remove old/conflicting docker packages
      apt:
        name:
          - docker.io
          - docker-doc
          - docker-compose
          - docker-compose-v2
          - podman-docker
          - containerd
          - runc
        state: absent
        purge: yes
      ignore_errors: true

    - name: Autoremove unused packages
      apt:
        autoremove: yes

    - name: Create keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Add Docker GPG key
      shell: |
        set -e
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: Add Docker apt repo
      shell: |
        set -e
        CODENAME=$(. /etc/os-release && echo "$VERSION_CODENAME")
        ARCH=$(dpkg --print-architecture)
        echo "deb [arch=${ARCH} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu ${CODENAME} stable" \
          > /etc/apt/sources.list.d/docker.list
      args:
        creates: /etc/apt/sources.list.d/docker.list

    - name: Apt update after adding Docker repo
      apt:
        update_cache: yes

    - name: Install Docker Engine (official)
      apt:
        name:
          - containerd.io
          - docker-ce
          - docker-ce-cli
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: true

    - name: Free port 80 and run nginx container
      shell: |
        set -e

        echo "== Who is using port 80? =="
        ss -lntp | grep ':80' || true

        echo "== Stop host webservers if running =="
        systemctl stop nginx 2>/dev/null || true
        systemctl stop apache2 2>/dev/null || true

        echo "== Remove ANY container publishing port 80 =="
        IDS="$(docker ps -q --filter "publish=80")"
        if [ -n "$IDS" ]; then
          docker rm -f $IDS
        fi
        

    echo "== Remove old 'web' container name if exists =="
    docker rm -f web 2>/dev/null || true

    echo "== Run nginx on port 80 =="
    docker run -d --name web --restart unless-stopped -p 80:80 nginx:alpine

    echo "== Verify locally =="
    curl -I http://127.0.0.1 | head -n 1

 
